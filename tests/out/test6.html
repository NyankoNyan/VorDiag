<!DOCTYPE html>
<html>
 <head>
  <title>canvas</title>
  <meta charset="utf-8">
  <script> 
var outputRepr = {"size":{"x":700,"y":700},"camera":[[0.29166666,0,0],[0,-0.29166666,0],[350,495.8333,1]],"edges":[{"x1":277.8927,"y1":77.06491,"x2":-1.6851717,"y2":237.29063},{"x1":692.9564,"y1":229.93593,"x2":484.12692,"y2":-205.51242},{"x1":428.46555,"y1":-347.98175,"x2":277.8927,"y2":77.06491},{"x1":484.12692,"y1":-205.51242,"x2":433.15646,"y2":-367.85718},{"x1":433.15646,"y1":-367.85718,"x2":428.46555,"y2":-347.98175},{"x1":428.46555,"y1":-347.98175,"x2":396.8772,"y2":215.9459},{"x1":484.12692,"y1":-205.51242,"x2":513.1298,"y2":175.02869},{"x1":277.8927,"y1":77.06491,"x2":239.4167,"y2":255.37012},{"x1":513.1298,"y1":175.02869,"x2":453.53284,"y2":238.19223},{"x1":513.1298,"y1":175.02869,"x2":594.09607,"y2":314.80255},{"x1":453.53284,"y1":238.19223,"x2":396.8772,"y2":215.9459},{"x1":396.8772,"y1":215.9459,"x2":345.16464,"y2":272.2411},{"x1":453.53284,"y1":238.19223,"x2":482.1361,"y2":287.24527},{"x1":840.2249,"y1":241.46536,"x2":784.5833,"y2":204.96544},{"x1":784.5833,"y1":204.96544,"x2":692.9564,"y2":229.93593},{"x1":840.2249,"y1":241.46536,"x2":786.72876,"y2":362.01672},{"x1":840.2249,"y1":241.46536,"x2":1129.6294,"y2":362.34412},{"x1":482.1361,"y1":287.24527,"x2":408.57065,"y2":324.84784},{"x1":482.1361,"y1":287.24527,"x2":573.5647,"y2":314.00858},{"x1":239.4167,"y1":255.37012,"x2":-1.6851717,"y2":237.29063},{"x1":408.57065,"y1":324.84784,"x2":345.16464,"y2":272.2411},{"x1":345.16464,"y1":272.2411,"x2":263.13177,"y2":282.4444},{"x1":692.9564,"y1":229.93593,"x2":667.5344,"y2":274.739},{"x1":412.45883,"y1":413.8889,"x2":263.09235,"y2":283.4119},{"x1":239.4167,"y1":255.37012,"x2":263.13177,"y2":282.4444},{"x1":786.72876,"y1":362.01672,"x2":667.5344,"y2":274.739},{"x1":408.57065,"y1":324.84784,"x2":417.47452,"y2":395.83707},{"x1":215.86317,"y1":405.3638,"x2":-67.59077,"y2":237.8773},{"x1":573.5647,"y1":314.00858,"x2":417.47452,"y2":395.83707},{"x1":263.13177,"y1":282.4444,"x2":263.09235,"y2":283.4119},{"x1":263.09235,"y1":283.4119,"x2":247.47337,"y2":403.7101},{"x1":667.5344,"y1":274.739,"x2":612.85175,"y2":322.48865},{"x1":824.38806,"y1":436.67886,"x2":613.2289,"y2":334.1775},{"x1":786.72876,"y1":362.01672,"x2":833.8256,"y2":428.62598},{"x1":573.5647,"y1":314.00858,"x2":594.09607,"y2":314.80255},{"x1":-1.6851717,"y1":237.29063,"x2":-67.59077,"y2":237.8773},{"x1":594.09607,"y1":314.80255,"x2":612.85175,"y2":322.48865},{"x1":612.85175,"y1":322.48865,"x2":613.2289,"y2":334.1775},{"x1":417.47452,"y1":395.83707,"x2":412.45883,"y2":413.8889},{"x1":613.2289,"y1":334.1775,"x2":610.41815,"y2":377.5071},{"x1":215.86317,"y1":405.3638,"x2":-103.57613,"y2":521.89404},{"x1":215.86317,"y1":405.3638,"x2":247.47337,"y2":403.7101},{"x1":-67.59077,"y1":237.8773,"x2":-10044.154,"y2":-612.705},{"x1":412.45883,"y1":413.8889,"x2":409.7075,"y2":433.49582},{"x1":367.1787,"y1":450.0666,"x2":247.62604,"y2":403.97873},{"x1":729.693,"y1":504.90305,"x2":610.41815,"y2":377.5071},{"x1":610.41815,"y1":377.5071,"x2":516.71545,"y2":499.66647},{"x1":247.47337,"y1":403.7101,"x2":247.62604,"y2":403.97873},{"x1":247.62604,"y1":403.97873,"x2":231.07776,"y2":490.26132},{"x1":409.7075,"y1":433.49582,"x2":367.1787,"y2":450.0666},{"x1":409.7075,"y1":433.49582,"x2":516.71545,"y2":499.66647},{"x1":1129.6294,"y1":362.34412,"x2":833.8256,"y2":428.62598},{"x1":833.8256,"y1":428.62598,"x2":824.38806,"y2":436.67886},{"x1":367.1787,"y1":450.0666,"x2":349.93787,"y2":515.49036},{"x1":824.38806,"y1":436.67886,"x2":764.1394,"y2":503.6874},{"x1":231.07776,"y1":490.26132,"x2":61.264465,"y2":546.57715},{"x1":526.78357,"y1":586.60706,"x2":349.93787,"y2":515.49036},{"x1":231.07776,"y1":490.26132,"x2":248.17456,"y2":527.23376},{"x1":349.93787,"y1":515.49036,"x2":334.07745,"y2":545.271},{"x1":310.31604,"y1":551.24115,"x2":248.17456,"y2":527.23376},{"x1":248.17456,"y1":527.23376,"x2":200.42674,"y2":611.9677},{"x1":764.1394,"y1":503.6874,"x2":729.693,"y2":504.90305},{"x1":729.693,"y1":504.90305,"x2":565.02844,"y2":669.1677},{"x1":334.07745,"y1":545.271,"x2":310.31604,"y2":551.24115},{"x1":334.07745,"y1":545.271,"x2":443.77383,"y2":678.02216},{"x1":764.1394,"y1":503.6874,"x2":864.1625,"y2":672.81433},{"x1":310.31604,"y1":551.24115,"x2":266.20602,"y2":670.52875},{"x1":516.71545,"y1":499.66647,"x2":526.78357,"y2":586.60706},{"x1":200.42674,"y1":611.9677,"x2":61.264465,"y2":546.57715},{"x1":1129.6294,"y1":362.34412,"x2":35400.56,"y2":2278.4265},{"x1":61.264465,"y1":546.57715,"x2":-93.12058,"y2":524.8601},{"x1":200.42674,"y1":611.9677,"x2":229.807,"y2":666.05646},{"x1":124.31114,"y1":680.55304,"x2":-93.12058,"y2":524.8601},{"x1":163.88408,"y1":683.9567,"x2":124.31114,"y2":680.55304},{"x1":124.31114,"y1":680.55304,"x2":113.464676,"y2":740.8702},{"x1":526.78357,"y1":586.60706,"x2":543.4913,"y2":664.71295},{"x1":163.88408,"y1":683.9567,"x2":141.06696,"y2":743.51764},{"x1":163.88408,"y1":683.9567,"x2":229.807,"y2":666.05646},{"x1":443.77383,"y1":678.02216,"x2":266.20602,"y2":670.52875},{"x1":229.807,"y1":666.05646,"x2":246.35944,"y2":677.7597},{"x1":266.20602,"y1":670.52875,"x2":246.35944,"y2":677.7597},{"x1":141.06696,"y1":743.51764,"x2":113.464676,"y2":740.8702},{"x1":141.06696,"y1":743.51764,"x2":234.50813,"y2":807.30725},{"x1":246.35944,"y1":677.7597,"x2":234.50813,"y2":807.30725},{"x1":113.464676,"y1":740.8702,"x2":-291.08743,"y2":941.75885},{"x1":-93.12058,"y1":524.8601,"x2":-103.57613,"y2":521.89404},{"x1":-103.57613,"y1":521.89404,"x2":-10044.154,"y2":-612.705},{"x1":811.6566,"y1":701.4081,"x2":622.05695,"y2":710.4574},{"x1":443.77383,"y1":678.02216,"x2":486.17157,"y2":695.0277},{"x1":864.1625,"y1":672.81433,"x2":811.6566,"y2":701.4081},{"x1":864.1625,"y1":672.81433,"x2":35400.56,"y2":2278.4265},{"x1":811.6566,"y1":701.4081,"x2":799.96155,"y2":803.92413},{"x1":565.02844,"y1":669.1677,"x2":543.4913,"y2":664.71295},{"x1":565.02844,"y1":669.1677,"x2":622.05695,"y2":710.4574},{"x1":543.4913,"y1":664.71295,"x2":486.17157,"y2":695.0277},{"x1":799.96155,"y1":803.92413,"x2":668.73096,"y2":898.09454},{"x1":457.98373,"y1":754.19366,"x2":262.95627,"y2":837.8232},{"x1":622.05695,"y1":710.4574,"x2":668.73096,"y2":898.09454},{"x1":486.17157,"y1":695.0277,"x2":457.98373,"y2":754.19366},{"x1":234.68855,"y1":808.36664,"x2":-291.08743,"y2":941.75885},{"x1":457.98373,"y1":754.19366,"x2":640.715,"y2":3380.7224},{"x1":234.50813,"y1":807.30725,"x2":234.68855,"y2":808.36664},{"x1":234.68855,"y1":808.36664,"x2":262.95627,"y2":837.8232},{"x1":262.95627,"y1":837.8232,"x2":660.0129,"y2":4150.382},{"x1":668.73096,"y1":898.09454,"x2":640.715,"y2":3380.7224},{"x1":640.715,"y1":3380.7224,"x2":660.0129,"y2":4150.382}],"rays":[{"x":433.15646,"y":-367.85718,"dx":-17.226547,"dy":-576.6144},{"x":784.5833,"y":204.96544,"dx":59.536194,"dy":-149.89484},{"x":799.96155,"y":803.92413,"dx":37.40753,"dy":70.80975},{"x":-291.08743,"y":941.75885,"dx":-182.16205,"dy":61.49391},{"x":660.0129,"y":4150.382,"dx":35.590576,"dy":619.5652},{"x":-10044.154,"y":-612.705,"dx":-581.9914,"dy":-58.91028},{"x":35400.56,"y":2278.4265,"dx":648.8457,"dy":33.5506}],"dots":[{"x":885.8594,"y":168.44559},{"x":495.01096,"y":232.10526},{"x":556.9709,"y":852.16504},{"x":630.22455,"y":497.9883},{"x":167.84134,"y":470.53317},{"x":820.3649,"y":325.2506},{"x":781.499,"y":854.6988},{"x":137.15855,"y":386.42377},{"x":852.3088,"y":817.29126},{"x":457.20148,"y":196.43071},{"x":740.8521,"y":381.4711},{"x":729.3358,"y":405.19516},{"x":735.96454,"y":108.90939},{"x":488.9201,"y":389.60043},{"x":405.82706,"y":523.9745},{"x":142.7266,"y":649.0722},{"x":359.4861,"y":353.63818},{"x":163.27603,"y":724.7514},{"x":161.30345,"y":345.56097},{"x":571.65564,"y":187.70761},{"x":159.35019,"y":126.13594},{"x":161.93382,"y":890.28937},{"x":373.51648,"y":864.9282},{"x":262.96088,"y":583.7626},{"x":175.62762,"y":154.53844},{"x":297.12592,"y":495.32892},{"x":100.43991,"y":708.1273},{"x":736.36597,"y":604.38824},{"x":339.10974,"y":189.8158},{"x":396.14072,"y":548.06146},{"x":463.24493,"y":340.62415},{"x":192.16125,"y":543.8668},{"x":427.80658,"y":271.29272},{"x":865.7645,"y":527.8608},{"x":791.4228,"y":312.40717},{"x":325.1203,"y":606.7478},{"x":345.63565,"y":369.49387},{"x":137.08052,"y":714.7162},{"x":319.53726,"y":739.0465},{"x":131.67867,"y":771.0363},{"x":745.9485,"y":805.1576}],"polygons":[],"arcs":[],"circles":[],"lines":[]};
var camera = [[1,0,0],[0,1,0],[0,0,1]];
var reverseCamera;

var matrixMult = function(x,y,m){
	return {
		"x":m[0][0]*x+m[1][0]*y+m[2][0],
		"y":m[0][1]*x+m[1][1]*y+m[2][1]
	};
};
var coordToCamera = function(x,y){
	return matrixMult(x,y,camera);
};
var scaleCoord = function(x,y){
	var c = camera;
	return {
		"x":c[0][0]*x+c[1][0]*y,
		"y":c[0][1]*x+c[1][1]*y
	};
}
var polygonColors = ["#CD5C5C", "#ADFF2F", "#7B68EE", "#FFA500",
"#F08080", "#00FF00", "#4682B4", "#A52A2A",
"#E9967A", "#32CD32", "#87CEFA", "#D2691E",
"#DC143C", "#00FA9A", "#4169E1",
"#B22222", "#9ACD32", "#FFD700",
"#FF69B4", "#808000", "#FFDAB9",
"#C71585", "#66CDAA", "#F0E68C",
"#DB7093", "#008B8B", "#9370DB"]; 
var getRayMult = function(){
	return 1000/(Math.abs(camera[0][0])+Math.abs(camera[0][1])+Math.abs(camera[1][0])+Math.abs(camera[1][1]));
};

var getMinor = function(m, x, y){
	var x1 = (x+1)%3;
	var x2 = (x+2)%3;
	var y1 = (y+1)%3;
	var y2 = (y+2)%3;
	return m[x1][y1]*m[x2][y2] - m[x1][y2]*m[x2][y1];
};
var getMinorMatrix = function(m){
	var result = [];
	for(var i = 0; i < 3; i++){
		result[i] = [];
		for(var j = 0; j < 3; j++){
			result[i][j] = getMinor(m, i, j);
		}
	}
	return result;
};
var backMatrix = function(m){	
	var mmin = getMinorMatrix(m);	
	var det = m[0][0] * mmin[0][0] - m[0][1] * mmin[0][1] + m[0][2] * mmin[0][2];	
	var result = [];
	for(var i = 0; i < 3; i++){
		result[i] = [];
		for(var j = 0; j < 3; j++){
			result[i][j] = mmin[j][i] / det * ((i+j)%2==0?1:-1);
		}
	}
	return result;		
};
window.onload = function() {
	var drawingCanvas = document.getElementById('smile');
	var coord;
	if(drawingCanvas && drawingCanvas.getContext) {
		var context = drawingCanvas.getContext('2d');
		if(outputRepr.camera!==undefined){
			for(var i = 0; i < 3; i++){
				for(var j = 0; j < 3; j++){
					if(outputRepr.camera[i][j] !== undefined){
						camera[i][j] = outputRepr.camera[i][j];
					}
				}
			}
		}
		reverseCamera = backMatrix(camera);
		if(outputRepr.size!==undefined){
			drawingCanvas.width = outputRepr.size.x;
			drawingCanvas.height = outputRepr.size.y;
		}
		var rayMult = getRayMult();		
		var minCorner = matrixMult(0, 0, reverseCamera);
		var maxCorner = matrixMult(drawingCanvas.width, drawingCanvas.height, reverseCamera);
		var xMin = Math.min(minCorner.x, maxCorner.x);
		var xMax = Math.max(minCorner.x, maxCorner.x);
		var xStep = (xMax - xMin) / drawingCanvas.width;
		var yMin = Math.min(minCorner.y, maxCorner.y);
		var yMax = Math.max(minCorner.y, maxCorner.y);
		
		context.shadowColor = "rgba(0,0,0,.5)";
		context.shadowBlur = 2;
		context.lineCap = 'round';
		context.lineJoin = 'round';
		context.lineWidth = 1;
		
		if(outputRepr.polygons!==undefined){
			for(var polyId = 0; polyId < outputRepr.polygons.length; polyId++){
				var poly = outputRepr.polygons[polyId];
				context.fillStyle = polygonColors[polyId % polygonColors.length];				
				
				context.beginPath();
				coord = coordToCamera(poly.dots[0].x, poly.dots[0].y);
				context.moveTo(coord.x, coord.y);
				for(var dotId = 1; dotId < poly.dots.length; dotId++){
					coord = coordToCamera(poly.dots[dotId].x, poly.dots[dotId].y);
					context.lineTo(coord.x, coord.y);
				}
				context.closePath();
				context.fill();
			}
		}
		if(outputRepr.edges!==undefined){
			context.strokeStyle = "#AA0";
			
			outputRepr.edges.forEach((elem)=>{				
				context.beginPath();
				coord = coordToCamera(elem.x1, elem.y1);
				context.moveTo(coord.x, coord.y);
				coord = coordToCamera(elem.x2, elem.y2);
				context.lineTo(coord.x, coord.y);				
				context.stroke();
			});
		}
		if(outputRepr.rays!==undefined){
			context.strokeStyle = "#0AA";
			
			outputRepr.rays.forEach((elem)=>{				
				context.beginPath();
				coord = coordToCamera(elem.x, elem.y);
				context.moveTo(coord.x, coord.y);
				var rayCoord = coordToCamera(elem.x+elem.dx*rayMult, elem.y+elem.dy*rayMult);
				context.lineTo(rayCoord.x, rayCoord.y);
				context.lineCap = 'round';
				context.stroke();
			});
		}	
		if(outputRepr.lines!==undefined){
			context.strokeStyle = "#AAA";
			
			outputRepr.lines.forEach((elem)=>{
				var x, y;
				var coord1, coord2;
				if(Math.abs(elem.dx) > Math.abs(elem.dy)){
					coord1 = coordToCamera((-elem.dy * yMin - elem.c) / elem.dx, yMin);
					coord2 = coordToCamera((-elem.dy * yMax - elem.c) / elem.dx, yMax);
				}else{
					coord1 = coordToCamera(xMin, (-elem.dx * xMin - elem.c) / elem.dy);
					coord2 = coordToCamera(xMax, (-elem.dx * xMax - elem.c) / elem.dy);
				}
				context.beginPath();
				context.moveTo(coord1.x, coord1.y);
				context.lineTo(coord2.x, coord2.y);
				context.stroke();
			});
		}
		if(outputRepr.circles!==undefined){
			context.setLineDash([5,5]);
			context.strokeStyle = "#A00";
			
			outputRepr.circles.forEach((elem)=>{
				var coord = coordToCamera(elem.x, elem.y);
				var size = scaleCoord(1, 1);
				context.beginPath();
				context.ellipse(coord.x, coord.y, elem.r*Math.abs(size.x), elem.r*Math.abs(size.y), 0, 0, Math.PI*2);
				context.stroke();
			});
			context.setLineDash([]);
		}
		if(outputRepr.arcs!==undefined){
			context.strokeStyle = "#00A";

			outputRepr.arcs.forEach((elem)=>{
				context.beginPath();
				drawMinX = Math.max(elem.minX, xMin);
				drawMaxX = Math.min(elem.maxX, xMax);
				var count = 0;
				for(var x = drawMinX; x < drawMaxX+xStep; x += xStep){
					var y = .5 * ((x - elem.fX) * (x - elem.fX) 
						+ elem.fY * elem.fY - elem.dirY * elem.dirY)
						/ (elem.fY - elem.dirY);
					var coord = coordToCamera(x,y);
					if(count==0){
						context.moveTo(coord.x, coord.y);
					}else{
						context.lineTo(coord.x, coord.y);
					}
					count++;
				}
				//context.closePath();
				context.stroke();
			});
		}
		if(outputRepr.dots!==undefined){
			context.fillStyle = "#FFF";
			context.strokeStyle = "#000";
			
			outputRepr.dots.forEach((elem)=>{				
				coord = coordToCamera(elem.x, elem.y);
				context.beginPath();
				context.arc(coord.x, coord.y, 3, 0, Math.PI*2);
				context.fill();
				context.stroke();				
			});
		}
	}
}
  </script>
 </head>
 <body>
  <canvas id="smile" width="200" height="200">
    <p>Ваш браузер не поддерживает рисование.</p>
  </canvas>
 </body>
</html>