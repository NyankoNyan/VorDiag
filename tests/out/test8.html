<!DOCTYPE html>
<html>
 <head>
  <title>canvas</title>
  <meta charset="utf-8">
  <script> 
var outputRepr = {"size":{"x":700,"y":700},"camera":[[0.5833333,0,0],[0,-0.5833333,0],[58.333332,641.6666,1]],"edges":[{"x1":1057.0271,"y1":144.24036,"x2":773.2029,"y2":150.92711},{"x1":750.422,"y1":47.21647,"x2":573.94495,"y2":234.24104},{"x1":750.422,"y1":47.21647,"x2":773.2029,"y2":150.92711},{"x1":872.2334,"y1":205.17122,"x2":773.53455,"y2":172.06262},{"x1":773.2029,"y1":150.92711,"x2":773.53455,"y2":172.06262},{"x1":773.53455,"y1":172.06262,"x2":768.39185,"y2":183.97354},{"x1":1057.0271,"y1":144.24036,"x2":872.2334,"y2":205.17122},{"x1":872.2334,"y1":205.17122,"x2":832.5867,"y2":274.16595},{"x1":832.5867,"y1":274.16595,"x2":768.39185,"y2":183.97354},{"x1":768.39185,"y1":183.97354,"x2":677.1572,"y2":275.83844},{"x1":448.88324,"y1":128.45532,"x2":299.38513,"y2":262.1342},{"x1":448.88324,"y1":128.45532,"x2":523.36847,"y2":230.84428},{"x1":832.42395,"y1":286.9273,"x2":681.8727,"y2":282.84644},{"x1":832.5867,"y1":274.16595,"x2":832.9615,"y2":285.90417},{"x1":299.38513,"y1":262.1342,"x2":-521.9446,"y2":240.32448},{"x1":832.9615,"y1":285.90417,"x2":832.42395,"y2":286.9273},{"x1":299.38513,"y1":262.1342,"x2":336.0681,"y2":361.77844},{"x1":832.42395,"y1":286.9273,"x2":835.3427,"y2":316.4052},{"x1":1561.7867,"y1":477.22903,"x2":835.3427,"y2":316.4052},{"x1":963.03143,"y1":441.96875,"x2":833.15204,"y2":323.2559},{"x1":835.3427,"y1":316.4052,"x2":833.15204,"y2":323.2559},{"x1":677.1572,"y1":275.83844,"x2":573.94495,"y2":234.24104},{"x1":833.15204,"y1":323.2559,"x2":753.82446,"y2":448.93814},{"x1":573.94495,"y1":234.24104,"x2":523.36847,"y2":230.84428},{"x1":677.1572,"y1":275.83844,"x2":681.8727,"y2":282.84644},{"x1":681.8727,"y1":282.84644,"x2":730.10406,"y2":439.02792},{"x1":523.36847,"y1":230.84428,"x2":502.23578,"y2":304.13858},{"x1":430.67447,"y1":376.17038,"x2":336.0681,"y2":361.77844},{"x1":336.0681,"y1":361.77844,"x2":285.4432,"y2":404.88483},{"x1":577.40955,"y1":425.26294,"x2":502.23578,"y2":304.13858},{"x1":502.23578,"y1":304.13858,"x2":430.67447,"y2":376.17038},{"x1":411.65308,"y1":476.36987,"x2":287.36768,"y2":409.43576},{"x1":285.4432,"y1":404.88483,"x2":-189.64627,"y2":378.44272},{"x1":430.67447,"y1":376.17038,"x2":429.9787,"y2":435.59058},{"x1":285.4432,"y1":404.88483,"x2":287.36768,"y2":409.43576},{"x1":287.36768,"y1":409.43576,"x2":311.63583,"y2":498.71155},{"x1":577.40955,"y1":425.26294,"x2":536.2375,"y2":464.319},{"x1":506.83038,"y1":468.45883,"x2":429.9787,"y2":435.59058},{"x1":577.40955,"y1":425.26294,"x2":662.91693,"y2":461.3585},{"x1":536.2375,"y1":464.319,"x2":506.83038,"y2":468.45883},{"x1":506.83038,"y1":468.45883,"x2":473.3926,"y2":642.4428},{"x1":536.2375,"y1":464.319,"x2":552.9493,"y2":571.3671},{"x1":429.9787,"y1":435.59058,"x2":411.65308,"y2":476.36987},{"x1":963.03143,"y1":441.96875,"x2":754.7232,"y2":449.74622},{"x1":311.63583,"y1":498.71155,"x2":68.44985,"y2":533.884},{"x1":411.65308,"y1":476.36987,"x2":387.19125,"y2":555.3016},{"x1":311.63583,"y1":498.71155,"x2":381.80368,"y2":554.63},{"x1":730.10406,"y1":439.02792,"x2":662.91693,"y2":461.3585},{"x1":662.91693,"y1":461.3585,"x2":631.6306,"y2":513.17596},{"x1":963.03143,"y1":441.96875,"x2":1561.7867,"y2":477.22903},{"x1":730.10406,"y1":439.02792,"x2":753.82446,"y2":448.93814},{"x1":631.6306,"y1":513.17596,"x2":552.9493,"y2":571.3671},{"x1":631.6306,"y1":513.17596,"x2":684.02515,"y2":641.6905},{"x1":753.82446,"y1":448.93814,"x2":754.7232,"y2":449.74622},{"x1":754.7232,"y1":449.74622,"x2":760.47205,"y2":478.73096},{"x1":808.0956,"y1":547.9267,"x2":760.47205,"y2":478.73096},{"x1":760.47205,"y1":478.73096,"x2":708.5086,"y2":623.3405},{"x1":940.959,"y1":609.4761,"x2":808.0956,"y2":547.9267},{"x1":808.0956,"y1":547.9267,"x2":792.37354,"y2":634.2948},{"x1":381.80368,"y1":554.63,"x2":189.80916,"y2":638.86395},{"x1":552.9493,"y1":571.3671,"x2":502.13843,"y2":639.7213},{"x1":792.37354,"y1":634.2948,"x2":708.5086,"y2":623.3405},{"x1":381.80368,"y1":554.63,"x2":387.19125,"y2":555.3016},{"x1":387.19125,"y1":555.3016,"x2":460.79056,"y2":635.2456},{"x1":792.37354,"y1":634.2948,"x2":824.9611,"y2":672.63074},{"x1":708.5086,"y1":623.3405,"x2":684.02515,"y2":641.6905},{"x1":940.959,"y1":609.4761,"x2":824.9611,"y2":672.63074},{"x1":684.02515,"y1":641.6905,"x2":652.27325,"y2":690.5121},{"x1":940.959,"y1":609.4761,"x2":1946.1337,"y2":511.09598},{"x1":460.79056,"y1":635.2456,"x2":236.13779,"y2":727.61566},{"x1":189.80916,"y1":638.86395,"x2":68.44985,"y2":533.884},{"x1":68.44985,"y1":533.884,"x2":-189.64627,"y2":378.44272},{"x1":824.9611,"y1":672.63074,"x2":817.8834,"y2":695.5187},{"x1":459.50894,"y1":705.9424,"x2":265.56638,"y2":767.89984},{"x1":892.53766,"y1":878.271,"x2":830.8835,"y2":706.6612},{"x1":830.8835,"y1":706.6612,"x2":817.8834,"y2":695.5187},{"x1":817.8834,"y1":695.5187,"x2":745.1152,"y2":757.6747},{"x1":652.27325,"y1":690.5121,"x2":502.13843,"y2":639.7213},{"x1":189.80916,"y1":638.86395,"x2":214.05629,"y2":699.58325},{"x1":460.79056,"y1":635.2456,"x2":473.3926,"y2":642.4428},{"x1":502.13843,"y1":639.7213,"x2":476.61313,"y2":644.8158},{"x1":214.05629,"y1":699.58325,"x2":48.23071,"y2":805.881},{"x1":473.3926,"y1":642.4428,"x2":476.61313,"y2":644.8158},{"x1":476.61313,"y1":644.8158,"x2":469.1616,"y2":691.8459},{"x1":652.27325,"y1":690.5121,"x2":670.5644,"y2":726.122},{"x1":551.1321,"y1":835.1194,"x2":469.1616,"y2":691.8459},{"x1":214.05629,"y1":699.58325,"x2":235.21335,"y2":726.8315},{"x1":469.1616,"y1":691.8459,"x2":459.50894,"y2":705.9424},{"x1":459.50894,"y1":705.9424,"x2":398.74567,"y2":820.32336},{"x1":235.21335,"y1":726.8315,"x2":145.9398,"y2":811.18835},{"x1":670.5644,"y1":726.122,"x2":556.7585,"y2":834.3268},{"x1":670.5644,"y1":726.122,"x2":699.6514,"y2":749.9831},{"x1":145.9398,"y1":811.18835,"x2":48.23071,"y2":805.881},{"x1":145.9398,"y1":811.18835,"x2":172.12607,"y2":877.90985},{"x1":-189.64627,"y1":378.44272,"x2":-521.9446,"y2":240.32448},{"x1":235.21335,"y1":726.8315,"x2":236.13779,"y2":727.61566},{"x1":236.13779,"y1":727.61566,"x2":255.66356,"y2":765.45123},{"x1":398.74567,"y1":820.32336,"x2":265.56638,"y2":767.89984},{"x1":745.1152,"y1":757.6747,"x2":699.6514,"y2":749.9831},{"x1":745.1152,"y1":757.6747,"x2":797.1576,"y2":821.6932},{"x1":699.6514,"y1":749.9831,"x2":664.895,"y2":890.106},{"x1":265.56638,"y1":767.89984,"x2":255.66356,"y2":765.45123},{"x1":255.66356,"y1":765.45123,"x2":253.4599,"y2":780.5829},{"x1":253.4599,"y1":780.5829,"x2":172.12607,"y2":877.90985},{"x1":253.4599,"y1":780.5829,"x2":381.62997,"y2":1225.9252},{"x1":797.1576,"y1":821.6932,"x2":678.07495,"y2":925.5396},{"x1":797.1576,"y1":821.6932,"x2":892.53766,"y2":878.271},{"x1":664.895,"y1":890.106,"x2":556.7585,"y2":834.3268},{"x1":398.74567,"y1":820.32336,"x2":429.83575,"y2":996.26166},{"x1":556.7585,"y1":834.3268,"x2":551.1321,"y2":835.1194},{"x1":551.1321,"y1":835.1194,"x2":429.83575,"y2":996.26166},{"x1":664.895,"y1":890.106,"x2":678.07495,"y2":925.5396},{"x1":1561.7867,"y1":477.22903,"x2":1946.1337,"y2":511.09598},{"x1":429.83575,"y1":996.26166,"x2":381.62997,"y2":1225.9252}],"rays":[{"x":750.422,"y":47.21647,"dx":27.01638,"dy":-214.41357},{"x":448.88324,"y":128.45532,"dx":-79.95962,"dy":-362.1765},{"x":832.9615,"y":285.90417,"dx":55.15561,"dy":-7.626831},{"x":1057.0271,"y":144.24036,"dx":117.806335,"dy":-29.436035},{"x":830.8835,"y":706.6612,"dx":46.040466,"dy":24.396606},{"x":48.23071,"y":805.881,"dx":-101.93164,"dy":32.006096},{"x":172.12607,"y":877.90985,"dx":-35.32318,"dy":93.62442},{"x":892.53766,"y":878.271,"dx":135.95416,"dy":97.77405},{"x":678.07495,"y":925.5396,"dx":12.273132,"dy":171.22589},{"x":-521.9446,"y":240.32448,"dx":-545.97546,"dy":-168.86136},{"x":1946.1337,"y":511.09598,"dx":398.33527,"dy":1.9448853},{"x":381.62997,"y":1225.9252,"dx":-29.391418,"dy":361.54236}],"dots":[{"x":758.28906,"y":666.34875},{"x":518.4389,"y":499.8575},{"x":267.87012,"y":335.9736},{"x":102.9719,"y":732.7018},{"x":350.54935,"y":727.7027},{"x":859.1447,"y":751.1207},{"x":484.4098,"y":493.3175},{"x":616.4247,"y":368.60236},{"x":829.498,"y":605.81726},{"x":270.16656,"y":539.4208},{"x":590.1448,"y":899.348},{"x":134.978,"y":834.6334},{"x":371.25513,"y":297.9135},{"x":358.11417,"y":751.3825},{"x":784.2785,"y":316.7663},{"x":860.0369,"y":364.58325},{"x":169.92209,"y":820.9189},{"x":564.0213,"y":492.74142},{"x":570.8803,"y":762.6122},{"x":876.72327,"y":346.32733},{"x":322.0231,"y":843.07},{"x":727.5148,"y":848.2517},{"x":885.4862,"y":306.745},{"x":260.33154,"y":471.42035},{"x":509.31912,"y":435.07556},{"x":350.67212,"y":433.2179},{"x":785.9657,"y":254.52391},{"x":837.3776,"y":758.941},{"x":631.3708,"y":583.8054},{"x":228.60242,"y":869.9566},{"x":877.8594,"y":251.58939},{"x":848.42334,"y":133.78305},{"x":767.66583,"y":594.5615},{"x":681.19867,"y":563.4909},{"x":829.29626,"y":223.68329},{"x":697.72205,"y":166.8858},{"x":629.09393,"y":823.8392},{"x":317.3977,"y":647.07477},{"x":271.83325,"y":186.72629},{"x":849.1473,"y":164.51013},{"x":137.58197,"y":786.69385},{"x":342.0634,"y":449.20288},{"x":866.09424,"y":526.819},{"x":478.61755,"y":815.3982},{"x":883.5413,"y":705.08026},{"x":761.37067,"y":887.0749},{"x":634.00977,"y":106.76667}],"polygons":[],"arcs":[],"circles":[],"lines":[]};
var camera = [[1,0,0],[0,1,0],[0,0,1]];
var reverseCamera;

var matrixMult = function(x,y,m){
	return {
		"x":m[0][0]*x+m[1][0]*y+m[2][0],
		"y":m[0][1]*x+m[1][1]*y+m[2][1]
	};
};
var coordToCamera = function(x,y){
	return matrixMult(x,y,camera);
};
var scaleCoord = function(x,y){
	var c = camera;
	return {
		"x":c[0][0]*x+c[1][0]*y,
		"y":c[0][1]*x+c[1][1]*y
	};
}
var polygonColors = ["#CD5C5C", "#ADFF2F", "#7B68EE", "#FFA500",
"#F08080", "#00FF00", "#4682B4", "#A52A2A",
"#E9967A", "#32CD32", "#87CEFA", "#D2691E",
"#DC143C", "#00FA9A", "#4169E1",
"#B22222", "#9ACD32", "#FFD700",
"#FF69B4", "#808000", "#FFDAB9",
"#C71585", "#66CDAA", "#F0E68C",
"#DB7093", "#008B8B", "#9370DB"]; 
var getRayMult = function(){
	return 1000/(Math.abs(camera[0][0])+Math.abs(camera[0][1])+Math.abs(camera[1][0])+Math.abs(camera[1][1]));
};

var getMinor = function(m, x, y){
	var x1 = (x+1)%3;
	var x2 = (x+2)%3;
	var y1 = (y+1)%3;
	var y2 = (y+2)%3;
	return m[x1][y1]*m[x2][y2] - m[x1][y2]*m[x2][y1];
};
var getMinorMatrix = function(m){
	var result = [];
	for(var i = 0; i < 3; i++){
		result[i] = [];
		for(var j = 0; j < 3; j++){
			result[i][j] = getMinor(m, i, j);
		}
	}
	return result;
};
var backMatrix = function(m){	
	var mmin = getMinorMatrix(m);	
	var det = m[0][0] * mmin[0][0] - m[0][1] * mmin[0][1] + m[0][2] * mmin[0][2];	
	var result = [];
	for(var i = 0; i < 3; i++){
		result[i] = [];
		for(var j = 0; j < 3; j++){
			result[i][j] = mmin[j][i] / det * ((i+j)%2==0?1:-1);
		}
	}
	return result;		
};
window.onload = function() {
	var drawingCanvas = document.getElementById('smile');
	var coord;
	if(drawingCanvas && drawingCanvas.getContext) {
		var context = drawingCanvas.getContext('2d');
		if(outputRepr.camera!==undefined){
			for(var i = 0; i < 3; i++){
				for(var j = 0; j < 3; j++){
					if(outputRepr.camera[i][j] !== undefined){
						camera[i][j] = outputRepr.camera[i][j];
					}
				}
			}
		}
		reverseCamera = backMatrix(camera);
		if(outputRepr.size!==undefined){
			drawingCanvas.width = outputRepr.size.x;
			drawingCanvas.height = outputRepr.size.y;
		}
		var rayMult = getRayMult();		
		var minCorner = matrixMult(0, 0, reverseCamera);
		var maxCorner = matrixMult(drawingCanvas.width, drawingCanvas.height, reverseCamera);
		var xMin = Math.min(minCorner.x, maxCorner.x);
		var xMax = Math.max(minCorner.x, maxCorner.x);
		var xStep = (xMax - xMin) / drawingCanvas.width;
		var yMin = Math.min(minCorner.y, maxCorner.y);
		var yMax = Math.max(minCorner.y, maxCorner.y);
		
		context.shadowColor = "rgba(0,0,0,.5)";
		context.shadowBlur = 2;
		context.lineCap = 'round';
		context.lineJoin = 'round';
		context.lineWidth = 1;
		
		if(outputRepr.polygons!==undefined){
			for(var polyId = 0; polyId < outputRepr.polygons.length; polyId++){
				var poly = outputRepr.polygons[polyId];
				context.fillStyle = polygonColors[polyId % polygonColors.length];				
				
				context.beginPath();
				coord = coordToCamera(poly.dots[0].x, poly.dots[0].y);
				context.moveTo(coord.x, coord.y);
				for(var dotId = 1; dotId < poly.dots.length; dotId++){
					coord = coordToCamera(poly.dots[dotId].x, poly.dots[dotId].y);
					context.lineTo(coord.x, coord.y);
				}
				context.closePath();
				context.fill();
			}
		}
		if(outputRepr.edges!==undefined){
			context.strokeStyle = "#AA0";
			
			outputRepr.edges.forEach((elem)=>{				
				context.beginPath();
				coord = coordToCamera(elem.x1, elem.y1);
				context.moveTo(coord.x, coord.y);
				coord = coordToCamera(elem.x2, elem.y2);
				context.lineTo(coord.x, coord.y);				
				context.stroke();
			});
		}
		if(outputRepr.rays!==undefined){
			context.strokeStyle = "#0AA";
			
			outputRepr.rays.forEach((elem)=>{				
				context.beginPath();
				coord = coordToCamera(elem.x, elem.y);
				context.moveTo(coord.x, coord.y);
				var rayCoord = coordToCamera(elem.x+elem.dx*rayMult, elem.y+elem.dy*rayMult);
				context.lineTo(rayCoord.x, rayCoord.y);
				context.lineCap = 'round';
				context.stroke();
			});
		}	
		if(outputRepr.lines!==undefined){
			context.strokeStyle = "#AAA";
			
			outputRepr.lines.forEach((elem)=>{
				var x, y;
				var coord1, coord2;
				if(Math.abs(elem.dx) > Math.abs(elem.dy)){
					coord1 = coordToCamera((-elem.dy * yMin - elem.c) / elem.dx, yMin);
					coord2 = coordToCamera((-elem.dy * yMax - elem.c) / elem.dx, yMax);
				}else{
					coord1 = coordToCamera(xMin, (-elem.dx * xMin - elem.c) / elem.dy);
					coord2 = coordToCamera(xMax, (-elem.dx * xMax - elem.c) / elem.dy);
				}
				context.beginPath();
				context.moveTo(coord1.x, coord1.y);
				context.lineTo(coord2.x, coord2.y);
				context.stroke();
			});
		}
		if(outputRepr.circles!==undefined){
			context.setLineDash([5,5]);
			context.strokeStyle = "#A00";
			
			outputRepr.circles.forEach((elem)=>{
				var coord = coordToCamera(elem.x, elem.y);
				var size = scaleCoord(1, 1);
				context.beginPath();
				context.ellipse(coord.x, coord.y, elem.r*Math.abs(size.x), elem.r*Math.abs(size.y), 0, 0, Math.PI*2);
				context.stroke();
			});
			context.setLineDash([]);
		}
		if(outputRepr.arcs!==undefined){
			context.strokeStyle = "#00A";

			outputRepr.arcs.forEach((elem)=>{
				context.beginPath();
				drawMinX = Math.max(elem.minX, xMin);
				drawMaxX = Math.min(elem.maxX, xMax);
				var count = 0;
				for(var x = drawMinX; x < drawMaxX+xStep; x += xStep){
					var y = .5 * ((x - elem.fX) * (x - elem.fX) 
						+ elem.fY * elem.fY - elem.dirY * elem.dirY)
						/ (elem.fY - elem.dirY);
					var coord = coordToCamera(x,y);
					if(count==0){
						context.moveTo(coord.x, coord.y);
					}else{
						context.lineTo(coord.x, coord.y);
					}
					count++;
				}
				//context.closePath();
				context.stroke();
			});
		}
		if(outputRepr.dots!==undefined){
			context.fillStyle = "#FFF";
			context.strokeStyle = "#000";
			
			outputRepr.dots.forEach((elem)=>{				
				coord = coordToCamera(elem.x, elem.y);
				context.beginPath();
				context.arc(coord.x, coord.y, 3, 0, Math.PI*2);
				context.fill();
				context.stroke();				
			});
		}
	}
}
  </script>
 </head>
 <body>
  <canvas id="smile" width="200" height="200">
    <p>Ваш браузер не поддерживает рисование.</p>
  </canvas>
 </body>
</html>